# 📋 Contracts Data Integration Guide

## Overview

The contracts page in the Contract Management System integrates with **Make.com** and **Google Docs** to provide contract generation, PDF creation, and document management capabilities.

---

## 🏗️ System Architecture

```
┌─────────────────────────────────────────────────────────────┐
│        Frontend: Contracts Page (app/[locale]/contracts)     │
├─────────────────────────────────────────────────────────────┤
│  - Fetches contracts from Supabase via /api/contracts        │
│  - Displays 33 contracts with status, parties, promoters     │
│  - Allows contract generation via Make.com integration       │
└────────────────┬────────────────────────────────────────────┘
                 │ HTTP
        ┌────────▼────────┐
        │  API Layer      │
        ├─────────────────┤
        │ /api/contracts  │ ◄── GET: Fetch all contracts
        │ /api/contract-  │     (from Supabase database)
        │   generation    │ ◄── POST: Generate PDF via
        │                 │     /api/pdf-generation
        │ /api/contracts/ │ ◄── POST: Handle Make.com
        │   makecom/      │     webhook & generate via
        │   generate      │     template system
        └────────┬────────┘
                 │
     ┌───────────┼──────────────┐
     │           │              │
     ▼           ▼              ▼
 Supabase    PDF Generation  Make.com
 Database    API             Templates

 • Contracts • /api/pdf-    • Contract
 • Parties     generation     templates
 • Promoters              • Webhooks
                          • Blueprints
```

---

## 📊 Data Flow: Contracts Page

### 1️⃣ **Frontend: Fetching Contracts Data**

**File:** `app/[locale]/contracts/page.tsx`

```typescript
// Step 1: Fetch contracts from API
const fetchContracts = useCallback(async () => {
  const response = await apiFetch('/api/contracts');
  const data = await response.json();
  setContracts(data.contracts || []);
}, []);
```

**What's returned:**

```json
{
  "success": true,
  "contracts": [
    {
      "id": "contract-1",
      "contract_number": "CTR-2025-001",
      "first_party_id": "party-1",
      "second_party_id": "party-2",
      "promoter_id": "promoter-1",
      "contract_start_date": "2025-01-01",
      "contract_end_date": "2026-12-31",
      "status": "active",
      "contract_type": "employment",
      "salary": 5000,
      "currency": "OMR",
      "pdf_url": "https://storage.example.com/contracts/pdf/contract-1.pdf",
      "google_doc_url": "https://docs.google.com/document/d/...",
      "first_party": { "id": "party-1", "name_en": "Company A" },
      "second_party": { "id": "party-2", "name_en": "Company B" },
      "promoters": { "id": "promoter-1", "name_en": "John Doe" }
    }
  ],
  "totalContracts": 33,
  "activeContracts": 28
}
```

---

### 2️⃣ **Backend API: `/api/contracts` - GET**

**File:** `app/api/contracts/route.ts`

**What it does:**

- Fetches contracts from Supabase `contracts` table
- Joins with `parties` and `promoters` tables
- Applies user permissions (non-admin users only see their contracts)
- Returns paginated results

**Key Database Columns:**

```sql
contracts
├── id (UUID)
├── contract_number (TEXT)
├── first_party_id (UUID) → parties.id
├── second_party_id (UUID) → parties.id
├── promoter_id (UUID) → promoters.id
├── contract_start_date (DATE)
├── contract_end_date (DATE)
├── status (VARCHAR) - 'active', 'expired', 'pending', etc.
├── contract_type (TEXT) - 'employment', 'service', 'consultancy', 'partnership'
├── salary (DECIMAL)
├── currency (VARCHAR)
├── pdf_url (TEXT) ⭐ Generated by Make.com/PDF API
├── google_doc_url (TEXT) ⭐ Google Docs link (legacy)
├── created_at (TIMESTAMP)
└── updated_at (TIMESTAMP)
```

---

## 🔗 Integration 1: Make.com Contract Generation

### Overview

The system integrates with **Make.com** to:

1. Generate contract templates
2. Create webhooks that trigger contract generation workflows
3. Store generated PDFs back in Supabase

### Workflow

```
Frontend Button: "Generate Contract via Make.com"
         │
         ▼
POST /api/contracts/makecom/generate
         │
         ├─ Validate contract type & data
         ├─ Generate Make.com blueprint
         ├─ Trigger Make.com webhook
         ├─ Store PDF URL in database
         └─ Return success
```

**File:** `app/api/contracts/makecom/generate/route.ts`

### Endpoint: `GET /api/contracts/makecom/generate?action=types`

Returns all contract types available for Make.com generation:

```json
{
  "success": true,
  "data": [
    {
      "id": "employment_contract",
      "name": "Employment Contract",
      "description": "Standard employment agreement",
      "category": "employment",
      "makecomTemplateId": "template-123",
      "requiredFields": ["first_party", "second_party", "job_title", "salary"],
      "optionalFields": ["benefits", "special_conditions"],
      "isActive": true,
      "requiresApproval": true
    }
  ]
}
```

### Endpoint: `GET /api/contracts/makecom/generate?action=template&type=employment_contract`

Returns Make.com template configuration:

```json
{
  "success": true,
  "data": {
    "contractConfig": {
      /* contract type config */
    },
    "templateConfig": {
      /* Make.com template settings */
    },
    "googleDocsTemplateId": "docs-id-123",
    "makecomModuleConfig": {
      /* webhook config */
    }
  }
}
```

### Endpoint: `POST /api/contracts/makecom/generate`

Generates a contract via Make.com:

**Request:**

```json
{
  "contractType": "employment_contract",
  "contractData": {
    "first_party_id": "party-1",
    "second_party_id": "party-2",
    "promoter_id": "promoter-1",
    "job_title": "Software Engineer",
    "salary": 5000,
    "currency": "OMR"
  },
  "triggerMakecom": true
}
```

**Response:**

```json
{
  "success": true,
  "contractId": "contract-1",
  "webhookPayload": {
    /* Make.com payload */
  },
  "pdfUrl": "https://storage.example.com/contracts/pdf/contract-1.pdf"
}
```

---

## 📄 Integration 2: PDF Generation

### Workflow

```
POST /api/contract-generation
         │
         ├─ Call /api/pdf-generation to generate PDF
         ├─ Receive pdf_url
         ├─ Update contract.pdf_url in Supabase
         ├─ Notify Make.com webhook (if configured)
         └─ Return pdf_url to frontend
```

**File:** `app/api/contract-generation/route.ts`

### Environment Variables

```env
# PDF Generation API - can be internal or external
NEXT_PUBLIC_API_URL=https://portal.thesmartpro.io
# or for relative paths:
# NEXT_PUBLIC_API_URL=/

# Make.com webhook URL
WEBHOOK_URL=https://hook.eu2.make.com/71go2x4zwsnha4r1f4en1g9gjxpk3ts4

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xyz.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx
```

### API Endpoint: `POST /api/contract-generation`

**Request:**

```json
{
  "contractId": "contract-1",
  "contractNumber": "CTR-2025-001",
  "html": "<html>Contract content...</html>"
}
```

**Response:**

```json
{
  "pdf_url": "https://storage.example.com/contracts/pdf/contract-1.pdf"
}
```

### Process Flow

1. **Frontend calls:** `POST /api/contract-generation`
2. **API server calls:** `POST /api/pdf-generation` (with full URL)
3. **PDF API returns:** `{ pdf_url: "https://..." }`
4. **API updates Supabase:** `contracts.update({ pdf_url: "..." })`
5. **API notifies Make.com webhook:** Sends contract status update
6. **API returns:** PDF URL to frontend

---

## 📊 Database Tables & Relationships

### Contracts Table

```sql
CREATE TABLE contracts (
  id UUID PRIMARY KEY,
  contract_number TEXT UNIQUE,
  first_party_id UUID REFERENCES parties(id),
  second_party_id UUID REFERENCES parties(id),
  promoter_id UUID REFERENCES promoters(id),
  contract_start_date DATE,
  contract_end_date DATE,
  status VARCHAR,
  contract_type TEXT,
  salary DECIMAL,
  currency VARCHAR,
  pdf_url TEXT,              -- ⭐ Stores generated PDF URL
  google_doc_url TEXT,       -- ⭐ Stores Google Docs link
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

### Relationships

```
Contracts ──┬──► Parties (first_party_id)
            ├──► Parties (second_party_id)
            └──► Promoters (promoter_id)
```

---

## 🔄 Data Update Triggers

### When is Contract Data Updated?

| Event             | Trigger                         | Updates                       |
| ----------------- | ------------------------------- | ----------------------------- |
| Contract Created  | User submits form               | All fields + timestamps       |
| PDF Generated     | Make.com or /api/pdf-generation | `pdf_url`, `status`           |
| Contract Approved | User clicks approve             | `status` to 'approved'        |
| Document Uploaded | User uploads to contract        | `pdf_url` or `google_doc_url` |
| Contract Expired  | Auto-check (daily)              | `status` to 'expired'         |

---

## 🎯 Current Implementation Status

### ✅ What's Working

- **Frontend:** Contracts page displays all 33 contracts correctly
- **Database:** All contract data persists in Supabase
- **PDF URLs:** Stored in `contracts.pdf_url` column
- **Google Docs:** Links stored in `contracts.google_doc_url` column
- **Make.com Integration:** Webhook configuration ready
- **Parties & Promoters:** Related data joins working correctly

### ⚠️ What Needs Configuration

1. **PDF Generation API** (`/api/pdf-generation`)
   - Currently returns empty or error
   - Need to implement actual PDF rendering
   - Or use external PDF service (e.g., Puppeteer, wkhtmltopdf)

2. **Make.com Webhook**
   - URL is configured: `https://hook.eu2.make.com/...`
   - Needs to be tested/verified in Make.com dashboard
   - Should trigger when contracts are generated

3. **Google Docs Integration**
   - Currently stores URLs only
   - Could auto-generate Google Docs from templates
   - Requires Google Docs API integration

---

## 🔧 How to Debug

### Check Contract Data in Database

```sql
-- View all contracts with relationships
SELECT
  c.id,
  c.contract_number,
  c.status,
  c.pdf_url,
  c.google_doc_url,
  p1.name_en AS first_party,
  p2.name_en AS second_party,
  pr.name_en AS promoter
FROM contracts c
LEFT JOIN parties p1 ON c.first_party_id = p1.id
LEFT JOIN parties p2 ON c.second_party_id = p2.id
LEFT JOIN promoters pr ON c.promoter_id = pr.id
LIMIT 10;
```

### Test Make.com Endpoint

```bash
# Get contract types
curl "http://localhost:3000/api/contracts/makecom/generate?action=types"

# Get specific template
curl "http://localhost:3000/api/contracts/makecom/generate?action=template&type=employment_contract"

# Generate contract
curl -X POST http://localhost:3000/api/contracts/makecom/generate \
  -H "Content-Type: application/json" \
  -d '{
    "contractType": "employment_contract",
    "contractData": { ... }
  }'
```

### Monitor Browser Console

```javascript
// Check what data the frontend received
console.log('Contracts:', window.contractsData);
console.log(
  'PDF URLs:',
  window.contractsData.map(c => c.pdf_url)
);
```

---

## 📋 Summary

| Aspect                 | Status        | Details                                     |
| ---------------------- | ------------- | ------------------------------------------- |
| **Frontend Display**   | ✅ Working    | 33 contracts showing correctly              |
| **Database Storage**   | ✅ Working    | All data persisted in Supabase              |
| **PDF URL Storage**    | ✅ Working    | `contracts.pdf_url` column active           |
| **Google Docs URLs**   | ✅ Working    | `contracts.google_doc_url` column active    |
| **Make.com Webhook**   | ⚠️ Configured | Needs verification in Make.com              |
| **PDF Generation API** | ⚠️ Needed     | Need to implement `/api/pdf-generation`     |
| **Data Fetching**      | ✅ Working    | `/api/contracts` returns all data correctly |

---

## 🚀 Next Steps

1. **Implement PDF Generation** (if not already done)
   - Create `/api/pdf-generation` endpoint
   - Use a PDF library (Puppeteer, PDFKit, etc.)
   - Return `{ pdf_url: "..." }`

2. **Verify Make.com Webhook**
   - Log in to Make.com dashboard
   - Verify webhook URL is receiving calls
   - Check payload format matches expectations

3. **Test End-to-End**
   - Generate a test contract
   - Verify PDF is created and URL is stored
   - Confirm Make.com webhook is triggered

4. **Consider Google Docs Integration** (Optional)
   - Use Google Docs API
   - Auto-generate docs from templates
   - Share documents with parties
