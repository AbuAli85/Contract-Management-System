name: Database Migration

on:
  push:
    branches: [main]
    paths:
      - 'supabase/migrations/**'
      - 'supabase/functions/**'
      - '.github/workflows/migrate.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

jobs:
  validate-migrations:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Validate migration naming and ordering
        run: npm run supabase:validate-migrations

  deploy-migrations:
    runs-on: ubuntu-latest
    needs: validate-migrations
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Set project reference
        id: set-project-ref
        run: |
          ENV="${{ github.event.inputs.environment || 'production' }}"
          if [ "$ENV" = "production" ]; then
            REF="${{ secrets.SUPABASE_PROJECT_REF }}"
          else
            REF="${{ secrets.SUPABASE_STAGING_PROJECT_REF || secrets.SUPABASE_PROJECT_REF }}"
          fi
          
          if [ -z "$REF" ]; then
            echo "‚ùå Error: SUPABASE_PROJECT_REF secret is not set"
            echo "Please set SUPABASE_PROJECT_REF in your GitHub repository secrets"
            echo "You can find your Project Ref in Supabase Dashboard ‚Üí Settings ‚Üí General ‚Üí Reference ID"
            exit 1
          fi
          
          echo "ref=$REF" >> $GITHUB_OUTPUT
          echo "‚úÖ Using project ref: ${REF:0:8}..." # Show first 8 chars for verification

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_ACCESS_TOKEN }}" ]; then
            echo "‚ùå Error: SUPABASE_ACCESS_TOKEN secret is not set"
            echo "Please set SUPABASE_ACCESS_TOKEN in your GitHub repository secrets"
            exit 1
          fi
          echo "‚úÖ Required secrets are configured"

      - name: Deploy to Supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ steps.set-project-ref.outputs.ref }}
        run: |
          echo "Deploying to ${{ github.event.inputs.environment || 'production' }}"
          echo "Project Ref: ${SUPABASE_PROJECT_REF:0:8}..." # Show first 8 chars

          # Ensure Supabase directories exist
          echo "üìÅ Creating Supabase directory structure..."
          mkdir -p supabase/.temp
          mkdir -p supabase/migrations
          
          # Link to Supabase project with retry logic
          echo "üîó Linking to Supabase project..."
          
          LINK_OUTPUT=""
          LINK_FAILED=true
          max_attempts=3
          attempt=1
          delay=5
          
          while [ $attempt -le $max_attempts ]; do
            echo "üîÑ Attempt $attempt of $max_attempts..."
            
            # Determine which command to run based on attempt number
            if [ $attempt -eq 1 ]; then
              # First attempt: try without password
              LINK_OUTPUT=$(supabase link --project-ref $SUPABASE_PROJECT_REF 2>&1) && LINK_FAILED=false || LINK_FAILED=true
            elif [ $attempt -eq 2 ] && [ -n "${{ secrets.SUPABASE_DB_PASSWORD }}" ]; then
              # Second attempt: try with password if available
              echo "üîê Retrying with database password..."
              # Try with password, ensuring no extra whitespace
              PASSWORD=$(echo "${{ secrets.SUPABASE_DB_PASSWORD }}" | tr -d '\n\r\t ')
              LINK_OUTPUT=$(supabase link --project-ref $SUPABASE_PROJECT_REF --password "$PASSWORD" 2>&1) && LINK_FAILED=false || LINK_FAILED=true
            elif [ -n "${{ secrets.SUPABASE_DB_PASSWORD }}" ]; then
              # Third attempt: try with password and debug flag, also try direct connection
              echo "üîç Retrying with password and debug mode..."
              PASSWORD=$(echo "${{ secrets.SUPABASE_DB_PASSWORD }}" | tr -d '\n\r\t ')
              
              # First try with pooler (default)
              LINK_OUTPUT=$(supabase link --project-ref $SUPABASE_PROJECT_REF --password "$PASSWORD" --debug 2>&1) && LINK_FAILED=false || LINK_FAILED=true
              
              # If still failing and error mentions pooler, suggest direct connection
              if [ "$LINK_FAILED" = true ] && echo "$LINK_OUTPUT" | grep -qi "pooler\|timeout"; then
                echo "‚ö†Ô∏è  Pooler connection failed. Note: Direct connection may work better in CI/CD."
                echo "üí° Consider using direct database connection string if pooler continues to fail."
              fi
            else
              # No password available, can't retry
              break
            fi
            
            # If successful, break out of loop
            if [ "$LINK_FAILED" = false ]; then
              echo "‚úÖ Successfully linked to Supabase project"
              break
            fi
            
            # Always show error output for debugging
            if [ -n "$LINK_OUTPUT" ]; then
              echo "üìã Error output from attempt $attempt:"
              echo "$LINK_OUTPUT"
              echo ""
            fi
            
            # Check if it's a timeout error and we should retry
            if echo "$LINK_OUTPUT" | grep -qi "timeout\|deadline exceeded\|connection.*refused"; then
              if [ $attempt -lt $max_attempts ]; then
                echo "‚è±Ô∏è  Connection timeout detected. Waiting ${delay}s before retry..."
                sleep $delay
                delay=$((delay * 2)) # Exponential backoff
              fi
            fi
            
            # Increment attempt counter
            attempt=$((attempt + 1))
          done
          
          if [ "$LINK_FAILED" = true ]; then
            echo ""
            echo "‚ùå Failed to link after $max_attempts attempts"
            echo ""
            echo "üìã Final error output:"
            echo "$LINK_OUTPUT"
            echo ""
            
            # Check error type and provide specific guidance
            if echo "$LINK_OUTPUT" | grep -qi "Wrong password\|password\|SASL\|auth\|authentication\|unauthorized"; then
              echo "‚ö†Ô∏è  Authentication error detected"
              
              # Check specifically for "Wrong password" error
              if echo "$LINK_OUTPUT" | grep -qi "Wrong password"; then
                echo ""
                echo "üî¥ INCORRECT DATABASE PASSWORD DETECTED"
                echo ""
                echo "The database password in SUPABASE_DB_PASSWORD secret is incorrect or has formatting issues."
                echo ""
                echo "üìã Troubleshooting Steps:"
                echo ""
                echo "1. Verify Password in Supabase Dashboard:"
                echo "   https://supabase.com/dashboard/project/${SUPABASE_PROJECT_REF}/settings/database"
                echo ""
                echo "2. Reset Password (Recommended if unsure):"
                echo "   - Click 'Reset Database Password' in Supabase Dashboard"
                echo "   - Copy the NEW password immediately (it won't be shown again)"
                echo ""
                echo "3. Update GitHub Secret:"
                echo "   - Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
                echo "   - Find 'SUPABASE_DB_PASSWORD'"
                echo "   - Click 'Update'"
                echo "   - Delete the old value completely"
                echo "   - Paste the NEW password (copy directly, don't type)"
                echo "   - Ensure no spaces before/after"
                echo "   - Click 'Update secret'"
                echo ""
                echo "4. Common Issues:"
                echo "   ‚ùå Password copied with extra spaces or newlines"
                echo "   ‚ùå Password contains special characters that need escaping"
                echo "   ‚ùå Using old password after reset"
                echo "   ‚ùå Password is case-sensitive - check capitalization"
                echo ""
                echo "5. Test Password Locally (Optional):"
                echo "   supabase link --project-ref ${SUPABASE_PROJECT_REF} --password 'YOUR_PASSWORD'"
                echo ""
                echo "6. If password contains special characters:"
                echo "   - Try URL-encoding special characters"
                echo "   - Or reset to a simpler password without special chars"
                echo ""
                exit 1
              fi
              
              if [ -z "${{ secrets.SUPABASE_DB_PASSWORD }}" ]; then
                echo ""
                echo "üí° Solution: Add SUPABASE_DB_PASSWORD secret"
                echo "   1. Go to Supabase Dashboard ‚Üí Settings ‚Üí Database"
                echo "   2. Find 'Database Password' section"
                echo "   3. Copy the password (or reset if needed)"
                echo "   4. Add it as SUPABASE_DB_PASSWORD secret in GitHub"
                exit 1
              else
                echo ""
                echo "üí° Possible issues:"
                echo "   - Database password might be incorrect"
                echo "   - Password might need to be reset in Supabase Dashboard"
                echo "   - Connection pooler might be blocking connections"
                echo "   - Access token might be invalid or expired"
                echo ""
                echo "üìã To fix:"
                echo "   1. Go to Supabase Dashboard ‚Üí Settings ‚Üí Database"
                echo "   2. Check 'Database Password' - verify or reset it"
                echo "   3. Update SUPABASE_DB_PASSWORD secret with the correct password"
                echo "   4. Verify SUPABASE_ACCESS_TOKEN is valid (Settings ‚Üí API ‚Üí Access Tokens)"
                echo "   5. Check if connection pooler is enabled (try direct connection)"
                exit 1
              fi
            elif echo "$LINK_OUTPUT" | grep -qi "timeout\|deadline exceeded"; then
              echo "‚è±Ô∏è  Connection timeout error detected"
              echo ""
              echo "üí° Possible causes:"
              echo "   - Connection pooler is timing out (common in CI/CD environments)"
              echo "   - Network connectivity issues from GitHub Actions"
              echo "   - Supabase project might be paused or experiencing issues"
              echo ""
              echo "üîß Troubleshooting steps:"
              echo "   1. Check Supabase project status in dashboard"
              echo "   2. Verify SUPABASE_PROJECT_REF is correct (20-character string)"
              echo "   3. Verify SUPABASE_ACCESS_TOKEN is valid and not expired"
              echo "   4. Try linking locally: supabase link --project-ref $SUPABASE_PROJECT_REF --debug"
              echo "   5. Check Supabase status page: https://status.supabase.com"
              echo "   6. Consider using direct database connection string if pooler continues to timeout"
              exit 1
            else
              # Other connection errors
              echo "üí° Troubleshooting steps:"
              echo "   1. Verify SUPABASE_PROJECT_REF is correct (20-character string)"
              echo "   2. Verify SUPABASE_ACCESS_TOKEN is valid and not expired"
              echo "   3. Check network connectivity to Supabase"
              echo "   4. Try linking locally: supabase link --project-ref $SUPABASE_PROJECT_REF --debug"
              echo "   5. Check Supabase project status in dashboard"
              echo "   6. Review the error output above for specific details"
              exit 1
            fi
          fi

          # Check migration status
          echo "üìä Checking migration status..."
          supabase migration list --linked || true
          
          # Attempt normal deployment first
          echo ""
          echo "üîÑ Attempting normal migration deployment..."
          if supabase db push --linked 2>&1 | tee /tmp/push_output.txt; then
            echo "‚úÖ Migrations deployed successfully!"
          else
            PUSH_OUTPUT=$(cat /tmp/push_output.txt)
            
            # Check if the error is about missing remote migrations
            if echo "$PUSH_OUTPUT" | grep -q "Remote migration versions not found"; then
              echo ""
              echo "‚ö†Ô∏è  Migration mismatch detected: Remote database has migrations not in local repo"
              echo ""
              echo "üìã This means:"
              echo "   - Remote database has migrations (001, 003, 006, etc.) that don't exist locally"
              echo "   - These were likely applied directly via Supabase Dashboard"
              echo ""
              echo "üí° Solutions:"
              echo ""
              echo "   Option 1 (Recommended): Sync migrations locally first"
              echo "   1. Run locally: supabase link --project-ref $SUPABASE_PROJECT_REF"
              echo "   2. Pull remote: supabase db pull --linked"
              echo "   3. Commit: git add supabase/migrations/ && git commit -m 'chore: sync migrations'"
              echo "   4. Push: git push"
              echo ""
              echo "   Option 2: Repair migration history (if migrations are no longer needed)"
              echo "   supabase migration repair --status reverted <migration_versions>"
              echo ""
              echo "üîÑ Attempting deployment with --include-all flag (may not work for this case)..."
              
              # Try pushing with --include-all (though it may not help for this specific error)
              if supabase db push --linked --include-all 2>&1; then
                echo "‚úÖ Migrations deployed with --include-all!"
              else
                echo ""
                echo "‚ùå Migration deployment failed"
                echo ""
                echo "üìã Migration status:"
                supabase migration list --linked || true
                echo ""
                echo "‚ö†Ô∏è  Action Required: You must sync migrations locally before deploying."
                echo "   See instructions above under 'Option 1'."
                exit 1
              fi
            else
              # Different error - show it and fail
              echo ""
              echo "‚ùå Migration deployment failed with error:"
              echo "$PUSH_OUTPUT"
              echo ""
              echo "üìã Migration status:"
              supabase migration list --linked || true
              exit 1
            fi
          fi

          # Deploy Edge Functions (if any exist)
          if [ -d "supabase/functions" ] && [ "$(ls -A supabase/functions)" ]; then
            echo "üîÑ Deploying Edge Functions..."
            supabase functions deploy --linked
          else
            echo "‚ÑπÔ∏è  No Edge Functions to deploy"
          fi

          echo "‚úÖ Deployment completed successfully"

      - name: Verify deployment
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ steps.set-project-ref.outputs.ref }}
        run: |
          echo "üîç Verifying deployment..."

          # Link to Supabase project (if not already linked)
          supabase link --project-ref $SUPABASE_PROJECT_REF --password ${{ secrets.SUPABASE_DB_PASSWORD || '' }} || true

          # Check if migrations were applied
          echo "üìä Checking migration status..."
          supabase db diff --linked || echo "‚ö†Ô∏è  Could not check diff (this is okay if no changes)"

          # List deployed functions (if any exist)
          if [ -d "supabase/functions" ] && [ "$(ls -A supabase/functions)" ]; then
            echo "üìã Listing deployed functions..."
            supabase functions list --linked || echo "‚ö†Ô∏è  Could not list functions"
          fi

          echo "‚úÖ Deployment verification completed"

      - name: Run post-deployment tests
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ steps.set-project-ref.outputs.ref }}
        run: |
          echo "üß™ Running post-deployment tests..."

          # Link to Supabase project (if not already linked)
          supabase link --project-ref $SUPABASE_PROJECT_REF --password ${{ secrets.SUPABASE_DB_PASSWORD || '' }} || true

          # Test database connectivity (dry run only - don't reset production!)
          if [ "${{ github.event.inputs.environment || 'production' }}" != "production" ]; then
            echo "üîç Testing database connectivity..."
            supabase db diff --linked || echo "‚ö†Ô∏è  Database connectivity check skipped"
          else
            echo "‚ÑπÔ∏è  Skipping database reset in production (safety)"
          fi

          # Test Edge Functions
          echo "Testing Edge Functions..."
          # Add your function tests here

          echo "‚úÖ Post-deployment tests completed"

  notify-deployment:
    runs-on: ubuntu-latest
    needs: deploy-migrations
    if: always()
    steps:
      - name: Notify deployment status
        run: |
          if [ "${{ needs.deploy-migrations.result }}" = "success" ]; then
            echo "‚úÖ Database migration deployment successful"
            # Add notification logic here (Slack, email, etc.)
          else
            echo "‚ùå Database migration deployment failed"
            # Add failure notification logic here
          fi
